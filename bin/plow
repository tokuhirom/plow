#!/usr/bin/env perl
use strict;
use warnings;
use utf8;
use 5.10.0;
use Getopt::Long;

GetOptions(
    'e=s' => \my $eval,
);

use FindBin;
use File::Spec;
use Plow::Syntax::Func;
use Plow;

my $libpath = File::Spec->catdir($FindBin::RealBin, '../lib');

if (defined $eval) {
    eval Plow->plowfy('-e', $eval);
    die $@ if $@;
} elsif (@ARGV > 0) {
    my $fname = shift @ARGV;
    eval Plow->plowfy($fname, do {
        open my $fh, '<', $fname;
        local $/;
        <$fh>
    });
    die $@ if $@;
} elsif (-t STDIN) {
    # repl
    run_repl();
} else {
    # run the code from stdin.
    eval Plow->plowfy('-', do { local $/; <STDIN> });
    die $@ if $@;
}

sub run_repl {
    require Term::ReadLine;
    require Term::ANSIColor;

    my $term = Term::ReadLine->new('plow');
    warn $term->ReadLine if $ENV{PLOW_DEBUG};
    while ( defined ($_ = $term->readline(Term::ANSIColor::colored(['yellow'], 'plow> '))) ) {
        my $ret = eval Plow->plowfy('-', $_);
        warn Term::ANSIColor::colored(['red'], $@) if $@;
        local $Data::Dumper::Terse  = 1;
        local $Data::Dumper::Indent = 0;
        print Term::ANSIColor::colored(['blue'], Data::Dumper::Dumper($ret)), "\n";
        $term->addhistory($_) if /\S/;
    }
}

__END__

=head1 NAME

plow - plow plow plow

=head1 SYNOPSIS

    % plow foo.plow

=head1 DESCRIPTION

Plow is a development suite for Perl5 hackers.

=head1 What's plow?

TBD
