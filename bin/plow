#!/usr/bin/env perl
use strict;
use warnings;
use utf8;
use 5.10.0;
use Getopt::Long;

GetOptions(
    'e=s' => \my $eval,
);

use FindBin;
use File::Spec;
use Plow::Signatures;
use Plow;

my $libpath = File::Spec->catdir($FindBin::RealBin, '../lib');

if (defined $eval) {
    eval plowfy('-e', $eval);
    die $@ if $@;
} elsif (@ARGV > 0) {
    my $fname = shift @ARGV;
    eval plowfy($fname, do {
        open my $fh, '<', $fname;
        local $/;
        <$fh>
    });
    die $@ if $@;
} elsif (-t STDIN) {
    # repl
    run_repl();
} else {
    # run the code from stdin.
    eval plowfy('-', do { local $/; <STDIN> });
    die $@ if $@;
}

sub run_repl {
    require Term::ReadLine;
    my $term = Term::ReadLine->new('plow');
    while ( defined ($_ = $term->readline('plow> ')) ) {
        eval plowfy('-', $_);
        warn $@ if $@;
    }
}

sub plowfy {
    my ($fname, $src) = @_;

    return join("\n",
        "use 5.10.0; use utf8::all; use Plow::Signatures;",
        "#line 1 $fname",
        $src,
    );
}

